name: Build Windows Executable

on:
  # Lancement manuel depuis l'interface GitHub
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (ex: 1.0.0)'
        required: false
        default: 'dev'

  # Automatique sur les tags de release
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pyqt5 reportlab

    - name: Create version file
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "push" ]]; then
          VERSION="${{ github.ref_name }}"
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Building version: $VERSION"

    - name: Build GUI executable
      run: |
        pyinstaller --onefile --windowed `
          --name "PortScanner-GUI" `
          --add-data "profiles;profiles" `
          --hidden-import "PyQt5.sip" `
          port_scanner.py

    - name: Build CLI executable
      run: |
        pyinstaller --onefile --console `
          --name "PortScanner-CLI" `
          --add-data "profiles;profiles" `
          port_scanner.py

    - name: Create distribution package
      shell: bash
      run: |
        mkdir -p release
        cp dist/PortScanner-GUI.exe release/
        cp dist/PortScanner-CLI.exe release/
        cp -r profiles release/

        # Creer un README pour Windows
        cat > release/LISEZMOI.txt << 'EOF'
        Port Scanner - Outil de scan de ports reseau
        =============================================

        FICHIERS:
        - PortScanner-GUI.exe : Version avec interface graphique
        - PortScanner-CLI.exe : Version ligne de commande
        - profiles/           : Dossier des profils de configuration

        UTILISATION GUI:
        Double-cliquez sur PortScanner-GUI.exe

        UTILISATION CLI:
        Ouvrez une invite de commandes et executez:

          PortScanner-CLI.exe --help
          PortScanner-CLI.exe --ip 192.168.1.1 --ports 22,80,443
          PortScanner-CLI.exe --profile "Web Standard" --ip 10.0.0.1
          PortScanner-CLI.exe --ip 192.168.1.0/24 --ports 22 -o rapport.json

        PROFILS:
        Les fichiers .profil dans le dossier profiles/ peuvent etre
        modifies avec un editeur de texte (Notepad, etc.)

        EOF

    - name: Upload GUI artifact
      uses: actions/upload-artifact@v4
      with:
        name: PortScanner-GUI-${{ env.VERSION }}
        path: release/PortScanner-GUI.exe

    - name: Upload CLI artifact
      uses: actions/upload-artifact@v4
      with:
        name: PortScanner-CLI-${{ env.VERSION }}
        path: release/PortScanner-CLI.exe

    - name: Upload complete package
      uses: actions/upload-artifact@v4
      with:
        name: PortScanner-Windows-${{ env.VERSION }}
        path: release/

    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/PortScanner-GUI.exe
          release/PortScanner-CLI.exe
        body: |
          ## Port Scanner ${{ github.ref_name }}

          ### Fichiers
          - **PortScanner-GUI.exe** - Version avec interface graphique
          - **PortScanner-CLI.exe** - Version ligne de commande (pour scripts/RMM)

          ### Utilisation CLI
          ```
          PortScanner-CLI.exe --ip 192.168.1.1 --ports 22,80,443
          PortScanner-CLI.exe --profile "Web Standard" --ip 10.0.0.1 -o rapport.json
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
